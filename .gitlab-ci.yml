
workflow:
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - when: always


variables:
  DOCKER_REGISTRY: wearestancer
  PHP_VERSION: "7.4"

Create archive:
  stage: deploy

  image: ${DOCKER_REGISTRY}/wordpress:php${PHP_VERSION}

  before_script:
    - php -v
    - composer --version
    - pnpm -v

  script:
    - pnpm run build:archive
    - export ZIP_NAME="wc-${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - echo "${ZIP_NAME}"
    - mv stancer*.zip "${ZIP_NAME}.zip"

  artifacts:
    paths:
      - '*.zip'


phpcs:
  stage: test

  image: ${DOCKER_REGISTRY}/php:${PHP_VERSION}

  before_script:
    - php -v
    - composer --version
    - composer create-project magento/magento-coding-standard --stability=dev magento-coding-standard

  script:
    - magento-coding-standard/vendor/bin/phpcs --ignore="vendor,node_modules,magento-coding-standard" --standard=Magento2 .

  artifacts:
    reports:
      junit: phpcs.junit.xml

eslint:
  stage: test
  image: ${DOCKER_REGISTRY}/wordpress:php${PHP_VERSION}

  before_script:
  - pnpm -v
  - composer create-project magento/magento-coding-standard --stability=dev magento-coding-standard
  - (cd magento-coding-standard && pnpm install);

  #Change This command by a script in our package.json when wrote.
  script:
  - magento-coding-standard/node_modules/.bin/eslint -c magento-coding-standard/eslint/.eslintrc --rulesdir magento-coding-standard/eslint/rules --debug ./view
